name: "24-Hour Key Rotation System"

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:     # Allows manual runs

env:
  GIST_ID: "c8d41aaaccf3f186d16f5a955c2d44cd"
  KEY_FILE: "key.txt"    # The filename in your gist

jobs:
  rotate_key:
    name: "Generate and Update Key"
    runs-on: ubuntu-latest
    
    steps:
    - name: Generate new secure key
      id: generate_key
      run: |
        # Generate 32-character alphanumeric key
        NEW_KEY=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9')
        echo "New key generated: ${NEW_KEY}"
        echo "KEY=${NEW_KEY}" >> $GITHUB_ENV
        echo "DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
        
    - name: Update the Gist
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GIST_TOKEN }}
        script: |
          await github.rest.gists.update({
            gist_id: process.env.GIST_ID,
            files: {
              [process.env.KEY_FILE]: {
                content: `Key: ${process.env.KEY}\nGenerated: ${process.env.DATE}\nExpires: ${new Date(Date.now() + 24*60*60*1000).toUTCString()}`
              }
            }
          })
          
    - name: Output verification
      run: |
        echo "Key rotation completed successfully"
        echo "New key was uploaded to your gist"
