name: "Daily Key Rotation"  # Workflow name (shows in Actions tab)

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:      # Allows manual runs

env:
  # Your specific identifiers (case-sensitive):
  GIST_ID: "c8d41aaaccf3f186d16f5a955c2d44cd"  # From your Gist URL
  GIST_FILENAME: "key.txt"  # Must match EXACT filename in your Gist

jobs:
  key_management:  # Internal job ID
    name: "Refresh Access Key"  # Friendly name in UI
    runs-on: ubuntu-latest
    
    steps:
    - name: "🔐 Generate Secure Key"  # Step 1 name
      id: keygen
      run: |
        NEW_KEY=$(openssl rand -hex 32)
        echo "NEW_KEY=$NEW_KEY" >> $GITHUB_ENV
        echo "::add-mask::$NEW_KEY"

    - name: "📤 Update Gist"  # Step 2 name
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GIST_UPDATE_TOKEN }}  # Reference to secret
        script: |
          await github.rest.gists.update({
            gist_id: process.env.GIST_ID,
            files: {
              [process.env.GIST_FILENAME]: {
                content: `KEY: ${process.env.NEW_KEY}\nUpdated: ${new Date().toISOString()}`
              }
            }
          })

    - name: "✅ Verify Update"  # Step 3 name
      run: |
        echo "Key rotated successfully!"
        echo "View at: https://gist.github.com/IYceA/$GIST_ID"
